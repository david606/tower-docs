# 幂等组件

## 功能发布记录

| 版本 | 拟制/修改日期 | 拟制/修改人 | 修改记录 | 批准人 |
| ---- | ------------- | ----------- | -------- | ------ |
| 1.0  | 2022/08/01    |             | 初版     |        |
|      |               |             |          |        |

## 重要通知

无

## 组件描述

### 1.1背景

铁塔大部分应用都是互联网应用，可以直接外网访问，对系统安全性要求就要很高。为了保证平台本身的安全，同时也为对上层应用提供更好的安全支撑，除了从服务器端采取措施防止网络攻击外，各系统也要保证数据的安全。

### 1.2 术语定义

| 序号 | 简称/术语 | 说明                                                         |
| ---- | --------- | ------------------------------------------------------------ |
| 1    | 幂等      | 表示一次和多次请求某一个资源应该具有同样的作用，或者说，多次请求所产生的影响与一次请求执行的影响效果相同 |

### 1.3 参考资料

| 序号 | 文档名称 | 最后修订时间 | 版本号 | 来源 |
| ---- | -------- | ------------ | ------ | ---- |
|      |          |              |        |      |

### 1.4 变更履历

| 变更日期 | 变更页次 | 变更后内容 | 版本号 | 修订人 | 批准人 |
| -------- | -------- | ---------- | ------ | ------ | ------ |
|          |          |            |        |        |        |

### 1.5 使用范围

幂等组件仅限于对token信息的创建校验，不参与业务处理。针对数据交互以及数据传递场景下使用，可以保证数据的安全性以及可靠性。

## 快速入门

无

## 操作指南

### 2.1 幂等组件

#### 2.1.1 组件概述

铁塔大部分应用都是互联网应用，可以直接外网访问，对系统安全性要求就要很高。为了保证平台本身的安全，同时也为对上层应用提供更好的安全支撑，除了从服务器端采取措施防止网络攻击外，各系统也要保证数据的安全。

幂等技术是表示一次和多次请求某一个资源应该具有同样的作用，或者说，多次请求所产生的影响与一次请求执行的影响效果相同，对用户恶意重复提交，接口超时重复提交起到一定的防范作用。

#### 2.1.2 环境要求

Jdk在1.8及以上

#### 2.1.3 功能清单

##### 2.1.3.1 创建token

创建token接口(无参形式)，面向开发者提供一个随机字符串。业务系统无需传递任何参数即可创建唯一token（仅使用一次），并将token返回给业务系统。

请求地址

| 方法名 | createToken |
| ------ | ----------- |
|        |             |

请求参数

| 参数名称 | 说明 | 约束 | 类型 | 备注 |
| -------- | ---- | ---- | ---- | ---- |
| 无       |      |      |      |      |

响应参数

| 方法返回值                           | 说明  |
| ------------------------------------ | ----- |
| 3524057c-c44e-4b9b-b255-14cb8bf0cf24 | Token |

##### 2.1.3.2 创建token(携带参数)

创建token接口(有参形式，url+userId,+param)，面向开发者提供一个唯一值。业务系统需要发送调用参数，组件将创建token返回给业务系统。Token会在指定时间失效。

请求地址

| 方法名 | createToken |
| ------ | ----------- |
|        |             |

请求参数

| 参数名称 | 说明     | 约束   | 类型   | 备注                           |
| -------- | -------- | ------ | ------ | ------------------------------ |
| url      | 接口url  | 必填   | String |                                |
| userId   | 用户id   | 必填   | String |                                |
| timeout  | 超时时间 | 必填   | Long   | 自定义token过期时间            |
| paramMap | 参数集合 | 非必填 | Map    | 用户请求自身服务后端的参数集合 |

响应参数

| 响应值                           | 说明  |
| -------------------------------- | ----- |
| 72c4e7161b23ea4357f5b025f6d72c5d | Token |

##### 2.1.3.3 校验token功能

面向开发者提供校验token有效性的方法。业务系统传递数据（token），可通过在redis中的存储数据性进行对比，将该token是否有效传递给业务系统。校验完的token立即失效。

请求地址

| 接口地址 | judgeToken |
| -------- | ---------- |
|          |            |

请求参数 （放入header中）

| 参数列表 | 约束 | 类型   | 备注                         |
| -------- | ---- | ------ | ---------------------------- |
| mdToken  | 必填 | String | 创建token(无参形式)给的token |

响应参数

| 参数列表 | 说明             |
| -------- | ---------------- |
| True     | 是第一次请求接口 |
| False    | 重复请求         |

##### 2.1.3.4 token删除

API接口，面向开发者提供的reids删除token的方法。业务系统传递token，组件获取token判断并从redis中删除token，并将删除结果返回给业务系统。

请求地址

| 接口地址 | deleteToken |
| -------- | ----------- |
|          |             |

请求参数（放入header中）

| 参数列表 | 约束 | 类型   | 备注          |
| -------- | ---- | ------ | ------------- |
| mdToken  | 必填 | String | 组件给的token |

响应参数

| 参数列表 | 说明     |
| -------- | -------- |
| True     | 删除成功 |
| False    | 删除失败 |

##### 2.1.3.5 查询参数功能

API接口，面向开发者提供的使用token查询当初传入的param的方法。业务系统传递token，可通过组件查询之前传进来的参数，并将结果返回给业务系统。

请求地址

| 接口地址 | findByParamByToken |
| -------- | ------------------ |
|          |                    |

请求参数 (放入header中)

| 参数列表 | 约束 | 类型   | 备注          |
| -------- | ---- | ------ | ------------- |
| mdToken  | 必填 | String | 组件给的token |

响应参数

| 参数列表 | 说明     | 类型   | 备注                           |
| -------- | -------- | ------ | ------------------------------ |
| url      | 接口url  | String |                                |
| userId   | 用户id   | String |                                |
| timeout  | 超时时间 | Long   | 自定义的过期时间               |
| paramMap | 参数集合 | Map    | 用户请求自身服务后端的参数集合 |

#### 2.1.4 集成说明

##### 2.1.4.1 集成说明

幂等是面向开发者使用API集成的技术组件。要求开发者在项目中引入该组件所生成的jar包。

##### 2.1.4.2 集成规范

在pom文件中：

<dependency>  <groupId>com.chinatower.component</groupId>  <artifactId>idempotent</artifactId>  <version>1.0.0</version>  </dependency>

在application.yml文件中（示例，按实际填写）

spring:
 redis:
 database: 0
 host: redisIP
 port: redis端口
 password: 密码
 connect-timeout: 10000
 jedis:
 pool:
 max-active: 8
 max-idle: 8
 min-idle: 0
 max-wait: -1

system:
 security:
 key: （key值在技术中台申请获取）

使用cache 方式

cache:
 url: IP

## 典型实践

无

## API参考

无

## SDK

```xml
<dependency>
    <groupId>com.chinatower.component</groupId>
    <artifactId>idempotent</artifactId>
    <version>1.0.0</version>
</dependency>
```

## 网络要求

无

## 常见问题

无

## 样例文件

无