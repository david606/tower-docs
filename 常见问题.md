# 常见问题

## 1. 技术中台

### 1.1. 没有技术中台登录权限

提交权限配置工单

1. 项目组填写权限申请的时候，提交给自己的项目。由自己的项目负责人审批是否开通权限。提交的内容描述需说明同时申请流水线和技术中台，并且提供正确的项目编码（CT）、模块编码（CTS）以及申请账号；（如不清楚可咨询一下工单平台的相关人员）
2. 项目组负责人审批后，会流转到管理员，管理员在4a配置技术中台和流水线的权限；
3. 管理员配置成功后会流转至流水线处理人员，处理人员进行配置人员和项目对应关系；
4. 流水线处理人员处理成功后，工单流转至技术中台处理人员，为账号分配团队角色；
5. 以上工单流转完成后，即可通过4A统一入口进入页面，访问技术中台和流水线；

### 1.2. 登录技术中台后申请能力或访问控制台报错"暂无角色信息，请联系管理员为您开通权限

提交配置工单给技术中台，工单配置成功后即可访问，如着急使用可在群中联系运维人员，提供出工单编号进行加急处理

### 1.3. 能力申请时选不到要申请能力的项目

提交权限配置工单给流水线，提供项目名称、ct和cts编码以及需绑定的账号（4A账号）

### 1.4. 各组件使用的开源组件的版本信息

右上角搜索框搜索对应的组件，在组件的介绍页面里有说明。

### 1.5. 技术中台能力申请要求

需由铁塔自有人员进行能力申请（微服务框架除外）

## 2. API网关

### 2.1. 网关的网络打通规则

1. 如果是被调用方，需打通网关到被调用服务的ip+端口
2. 如果是调用方，需打通服务到网关的ip+端口
3. 既是调用方也是服务方需要双向打通ip+端口

### 2.2. 通过网关调用其他服务500报错

#### 2.2.1. 1. 判断是否为网关报错

① 检查feignclient url为各个环境网关的地址

![image1 1](http://mid.chinatowercom.cn:18080/docs/mid-platform/v1.0/module/gateway/image1-1.png)

② 检查返回报文格式。注意: 网关报错返回报文requestId字段一定存在，若无此字段则 不是网关返回报错，直接找被调方微服务负责人员。

![image1 2](http://mid.chinatowercom.cn:18080/docs/mid-platform/v1.0/module/gateway/image1-2.png)

#### 2.2.2. 2. 检查网络

若经过上面步骤确定是调用的网关，下一步检查是否按要求打通了网关和业务微服务之间的网络，具体网络打通方法在”技术中台“→”我的能力“，网关能力详情页面可以查看

#### 2.2.3. 3. 如何查询网关交互日志

若已确认网络正确打通，则需要查询网关侧日志，查询方法如下：

假设我们想要查找2024-05-09 12:57:34的一条500报错日志，只需按以下步骤操作：

① 进入网关交互日志存放位置

```shell
  cd /app/logs/chntjszt-wfwkj/chinatower-api-gateway/8097
```

② 根据日期筛选2024-05-09当天所有交互日志压缩文件

```shell
  ls -lth transaction-2024-05-09.*
```

![image1 3](http://mid.chinatowercom.cn:18080/docs/mid-platform/v1.0/module/gateway/image1-3.png)

③ 根据日志文件时间可知要找的日志在12:55到13:07之间

![image1 4](http://mid.chinatowercom.cn:18080/docs/mid-platform/v1.0/module/gateway/image1-4.png)

④ zgrep命令搜索具体zip文件，关键字一般为接口名称

```shell
  zgrep '关键字' transaction-2024-05-09.114.zip
```

![image1 5](http://mid.chinatowercom.cn:18080/docs/mid-platform/v1.0/module/gateway/image1-5.png)

⑤ 最后根据日志中的date，即可找到目标日志  交互日志为json格式，请求与响应成对出现，同一对请求与响应xb3TraceId和xb3SpanId字段相同，且系统日志中也包含这两个值

![image1 6](http://mid.chinatowercom.cn:18080/docs/mid-platform/v1.0/module/gateway/image1-6.png)

#### 2.2.4. 4. 查询系统日志

如需获取更多日志信息，可根据如下方法获取系统日志： ① 进入系统日志存放位置

```shell
  cd /app/logs/10.1004
```

② 根据交互日志中的xb3TraceId查询对应系统日志

```shell
  zgrep '320842cc0e3ef7a1' system-2024-05-09-12.1.zip
```

![image1 7](http://mid.chinatowercom.cn:18080/docs/mid-platform/v1.0/module/gateway/image1-7.png)

### 2.3. 请求网关无响应

问题如图：

![image1 8](http://mid.chinatowercom.cn:18080/docs/mid-platform/v1.0/module/gateway/image1-8.png)

这种情况看响应header，若token is unavailable，找4A

![image1 9](http://mid.chinatowercom.cn:18080/docs/mid-platform/v1.0/module/gateway/image1-9.png)

### 2.4. 通过网关调其他服务调不通

先自行排出服务到网关网络是否通（方法：telnet 网关ip 端口），如果是通的在联系被调用方是否已打通网关到被调用方服务的网络，如不确定再联系运维人员配合核查

### 2.5. 微服务网关是否支持文件上传？

不支持，微服务网关目前的定位是跨系统间的接口调用。

### 2.6. 与注册中心的区别

注册中心只记录服务名与实例的清单信息，并不实际承载业务流量。

![image-20240722101229820](../.aassets/image-20240722101229820.png)

![image-20240722101259901](../.aassets/image-20240722101259901.png)



### 2.7. 网关调用接口时好时坏

核查是否自己本地起服注册到注册中心了

### 2.8. 通过网关调用404

1. 检查目标微服务是否已申请网关能力
2. 直连目标微服务地址测试是否OK

### 2.9. 套装类软件如何通过网关对接4A系统？

1. 申请Nacos注册中心能力，并查看Nacos注册中心开发文档中关于 [套装类软件如何集成](http://mid.chinatowercom.cn:18080/docs/chinatower-microservice-component/v1.0/module/nacos-discovery.html#taozhuan-nacos) 章节的说明。
2. 申请网关能力
3. 查看涉及组件的能力详情页面，根据能力详情进行网络打通。

## 3. 代码私服

### 3.1. 如何判断私服中是否存在一个后端/前端的依赖包

1. 使用浏览器打开私服 [点击访问](http://10.38.77.5:8081)
2. 点击左侧菜单**Search**，在**Keyword**文本输入框中输入要查询的关键词，点击**Enter**键发起查询
3. 也可以点击**More criteria**按钮，选择**Maven Repositories**，再选择**GroupId**或者**Artifact Id**或者**Base Version** 进行精细化查询。同理可进行**npm**的精细化查询。
4. 可以通过访问流水线构建时输出的错误地址日志进行测试。将具体的地址输入到浏览器地址栏中，如果本地已完成下载，则私服中存在此依赖。

### 3.2. 私服缺少依赖怎么办？

1. 如果缺少Maven依赖，在技术中台申请Nexus私服，审批后手动上传依赖。
2. 如果缺少Npm依赖，技术中台暂不支持前端私服的申请及手动上传，请手动下载前端依赖的tgz压缩包。自有项目经理发邮件给技术中台项目经理，内容包括：包附件、包简要说明、使用场景、业务系统二级系统编码。

## 4. Eureka注册中心

### 4.1. Eureka注册中心无法注册报错

确保eureka的配置和下图保持一致，仅修改authToken和defaultZone值为我的能力审批后返回的详情信息，其他字段不修改

```yml
eureka:
  instance:
    prefer-ip-address: true
    instance-id: ${spring.application.name}:${spring.cloud.client.ip-address}:${server.port}
    hostname: ${spring.cloud.client.ip-address}
    statusPageUrlPath: ${management.endpoints.web.base-path:}/info
    healthCheckUrlPath: ${management.endpoints.web.base-path:}/health
  client:
    authToken: ff8d410348a50cb5a9c895d1a701b863
    serviceUrl:
      defaultZone: http://10.180.22.9:8761/eureka
```

### 4.2. 使用nacos注册中心的服务可以调用eureka上注册的服务吗

可以，eureka注册中心上注册后，会同步到nacos注册中心供调用方调用，同样的nacos上注册的服务也会同步到eureka注册中心中，开发者不需要考虑自己的服务是注册在nacos还是eureka。

### 4.3. 注册中心是否可以提供公网地址？

不可以，目前微服务基础能力中，只有网关有公网地址，其他组件都不会提供公网地址,且只提供联通云环境的内网地址。上海三可以联系网络组进行点对点隧道打通;上海四无法打通网络，对接4A请使用能开渠道。

### 4.4. 各组件提供的ip地址哪里获取？

为了安全起见，在技术中台申请对应的能力后，详情页面会显示对应的地址信息。（提示：各环境的能力需要单独申请）

### 4.5. eureka注册中心日志返回204状态码是否正常？

正常。无须担心

### 4.6. 目标服务名不是以chnt开头，怎么申请能力

根据是否已上生产环境为区分，若服务已上生产环境，则通过后台补录数据的方式进行操作，若生产环境不存在，则打回。

1. 业务组线下联系运营团队，告知要申请token的服务名，以及目标环境。
2. 运营团队验证此服务名是否已在生产环境正常运行。若生产环境不存在，则打回，不允许。若存在，运营团队联系三线建设团队生成token。
3. 运营团队返回token给业务组。
4. 业务组代码配置token并进行启服。
5. 运营团队通过后台进行数据绑定操作。

### 4.7. 本地开发如何避免影响idc测试

本地开发时，应添加此配置防止跨服务调用时因网络不通联调失败。

eureka

```yml
eureka:
  client:
    register-with-eureka: false
```

nacos

```yml
spring:
  cloud:
    nacos:
      discovery:
        enabled: false
```

## 5. Nacos注册中心

### 5.1. 注册报错情况1

#### 5.1.1. 现象

同一个jar在IDC、验收、准生产、生产环境多个环境中，存在服务在部分环境无法正常启动的现象

error.log

```none
2023-04-03 18:15:13 [INFO][org.springframework.cloud.commons.util.InetUtils][convertAddress][170]-> Cannot determine local hostname
2023-04-03 18:15:15 [INFO][org.springframework.cloud.commons.util.InetUtils][convertAddress][170]-> Cannot determine local hostname
2023-04-03 18:15:25 [ERROR][com.alibaba.cloud.nacos.discovery.NacosWatch][start][136]-> namingService subscribe failed, properties:NacosDiscoveryProperties{serverAddr='192.168.157.107:8848', username='', password='', endpoint='', namespace='', watchDelay=30000, logName='', service='xxx', weight=1.0, clusterName='DEFAULT', group='DEFAULT_GROUP', namingLoadCacheAtStart='false', metadata={preserved.register.source=SPRING_CLOUD}, registerEnabled=true, ip='xxx', networkInterface='', port=-1, secure=false, accessKey='xxx', secretKey='', heartBeatInterval=null, heartBeatTimeout=null, ipDeleteTimeout=null, instanceEnabled=true, ephemeral=true, failureToleranceEnabled=false}, ipDeleteTimeout=null, failFast=true}
com.alibaba.nacos.api.exception.NacosException: Client not connected, current status:STARTING
	at com.alibaba.nacos.common.remote.client.RpcClient.request(RpcClient.java:655)
	at com.alibaba.nacos.common.remote.client.RpcClient.request(RpcClient.java:635)
	at com.alibaba.nacos.client.naming.remote.gprc.NamingGrpcClientProxy.requestToServer(NamingGrpcClientProxy.java:304)
	at com.alibaba.nacos.client.naming.remote.gprc.NamingGrpcClientProxy.doSubscribe(NamingGrpcClientProxy.java:255)
	at com.alibaba.nacos.client.naming.remote.gprc.NamingGrpcClientProxy.subscribe(NamingGrpcClientProxy.java:240)
	at com.alibaba.nacos.client.naming.remote.NamingClientProxyDelegate.subscribe(NamingClientProxyDelegate.java:160)
	at com.alibaba.nacos.client.naming.NacosNamingService.subscribe(NacosNamingService.java:404)
	at com.alibaba.cloud.nacos.discovery.NacosWatch.start(NacosWatch.java:132)
	at org.springframework.context.support.DefaultLifecycleProcessor.doStart(DefaultLifecycleProcessor.java:178)
	at org.springframework.context.support.DefaultLifecycleProcessor.access$200(DefaultLifecycleProcessor.java:54)
	at org.springframework.context.support.DefaultLifecycleProcessor$LifecycleGroup.start(DefaultLifecycleProcessor.java:356)
	at java.lang.Iterable.forEach(Iterable.java:75)
	at org.springframework.context.support.DefaultLifecycleProcessor.startBeans(DefaultLifecycleProcessor.java:155)
	at org.springframework.context.support.DefaultLifecycleProcessor.onRefresh(DefaultLifecycleProcessor.java:123)
	at org.springframework.context.support.AbstractApplicationContext.finishRefresh(AbstractApplicationContext.java:935)
	at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:586)
	at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.refresh(ServletWebServerApplicationContext.java:145)
	at org.springframework.boot.SpringApplication.refresh(SpringApplication.java:745)
	at org.springframework.boot.SpringApplication.refreshContext(SpringApplication.java:420)
	at org.springframework.boot.SpringApplication.run(SpringApplication.java:307)
	at org.springframework.boot.SpringApplication.run(SpringApplication.java:1317)
	at org.springframework.boot.SpringApplication.run(SpringApplication.java:1306)
	at com.chinatower.product.threed.ThreedApplication.main(ThreedApplication.java:20)
```

#### 5.1.2. 解决方案

查看hostname

![chinatower registry question 1](../.aassets/chinatower-registry-question-1.jpg)

查看/etc/hosts

![chinatower registry question 2](../.aassets/chinatower-registry-question-2.jpg)

**如果存在hostname不在hosts文件中，申请运维工单**

### 5.2. 套装类软件如何集成

|      | 请先申请Nacos注册中心，在我的能力详情中获得accessKey |
| ---- | ---------------------------------------------------- |
|      |                                                      |

#### 5.2.1. 源码是JAVA语言且为spring cloud微服务架构

根据注册中心提供的样例工程，添加技术中台提供的依赖jar坐标，配置相应参数，重新打包和部署。

#### 5.2.2. 源码非JAVA语言：

- 方案1: 尝试Nacos官网其他语言SDK，并二开添加 `authToken` 请求头，值为我的能力审批通过后返回的accessKey数据。
- 方案2: 使用Rest API自行发起 注册、续约、下线三个接口调用，调用的同时将在技术中台申请的accessKey作为authToken请求头的值放到请求中

![chinatower registry question 3](../.aassets/chinatower-registry-question-3.png)

## 6. 分布式文件管理

### 6.1. 支持哪些格式？

支持以下文件: 'png', 'gif' ,'bmp', 'ico', 'jpeg', 'jpg', 'zip' ,'rar'  ,'pdf' ,'ppt' ,'xls' ,'xlsx' ,'pptx' ,'doc' ,'docx' ,'txt' ,'mp3' ,'mp4' ,'flv' ,'html' ,'jar' ,'war' ,'dat' ,'sql' ,'' ,'csv' ,'7z' ,'xlsm'  ,'tar' ,'tif' ,'tiff' ,'json' ,'vsd' ,'rtf' ,'dwg' ,'log' ,'avi'  ,'xmind' ,'xml' ,'yml' ,'vsdx'

### 6.2. 最底层存储方式是什么

NAS

## 7. ES搜索组件

### 7.1. ES搜索组件模糊查询详细样例

key名和值自行确定

```json
{
    "queryObj":{
        "key":[
            "unit"
        ],
        "value":[
            "圣达"
        ]
    },
    "indexName":[
        "kele_test_1"
    ],
    "highLightVo":{
        "preTags":"<",
        "postTags":">",
        "fields":[
            "unit"
        ]
    },
    "sortMap":{
        "age":1
    }
}
```

### 7.2. ES搜索组件插入接口样例

```json
{
    "indexName": "chinatowerMDM",
    "dataId": "1",
    "data": {
        "name": "shangqw",
        "age": "31",
        "address": "海淀区"
    }
}
```

## 8. 短信组件

### 8.1. 短信模板配置【】但显示时是（）

审核短信模板时，【】是不能带的，艾派网关在发送给用户时会吧【】换成（）

## 9. 其他说明

- 申请能力后，确定接入服务与所申请能力的网络是否通，如不通，请前往运维工单平台提交打通网络的申请单
- Nexus私服申请以项目为维度，同一个项目只需申请一次
- 申请私有zookeeper之后，申请kafka，需要填写zk的信息
- 能力申请时务必按照要求进行信息填写，例如自定义名称命名要求
- 针对没有使用过rabbitmq的系统申请时vhost不允许申请“/”
- 网关无限制， 但4A的获取token接口有频率限制
- 注册中心申请时填写的服务名与实际的服务名要一致
- 生产环境和测试环境相比有严格的安全校验，必须要使用铁塔的包
- 定时任务、统一通知、统一通过技术中台进行登录。
- 定时作业组件使用注意事项：
  - 定时作业不允许秒级
  - 应用接入系统升级上线暂停服务时，需要提前将任务关闭，等服务启动后再开启任务，否则会造成大量的异常连接
  - 上线前需要提前3天打通各个环境的网络
  - 网络需要双向都能telnet通，请提前验证
  - 服务器时间误差也会造成任务调用失败
  - 网络不通的情况下，不能一直开启着任务