# [Request 网络请求](http://mid.chinatowercom.cn:18080/appGuide/base/request.html#request-网络请求)

Request 网络请求主要用于请求API接口，封装 uni.request，支持拦截器、Promise、默认配置、中断请求等功能，支持`post`、`get`、`request`以及`upload`、`download`等请求，有如下特点：

- 基于`Promise`实现更便捷的uni.request功能
- 多种 Method，get/post/request/upload/download 方法请求
- 支持请求、响应拦截器
- 支持自定义返回Http Code范围，如axios的validateStatus
- 支持默认参数设定，及对应uni.request参数设定
- 支持文件上传/下载请求
- 支持 RequestTask 取消/中断请求操作
- 支持设定请求loading及遮罩层mask
- 支持debug模式

### [集成方式](http://mid.chinatowercom.cn:18080/appGuide/base/request.html#集成方式)

在main.js进行集成即可

```javascript
import ctmobile from '@ct/china-tower-mobile' // 引用组件库

// 进行实例化
const request = new ctmobile.request({
	baseUrl: <BaseUrl>,
	timeout: <TimeOut>,
  loadMask: true,
  debug: true,
})

// 全局挂载后使用即可
Vue.prototype.$request = request
```

### [基础使用](http://mid.chinatowercom.cn:18080/appGuide/base/request.html#基础使用)

挂载全局变量，直接进行使用

```javascript
get: this.$request.get(url, <options = {}>)
post: this.$request.post(url, <data = {}>, <options = {}>)
request: this.$request.post(options) // 默认为POST
upload: this.$request.upload(options) // 上传
download: this.$request.download(options) // 下载
```

### [默认配置参数](http://mid.chinatowercom.cn:18080/appGuide/base/request.html#默认配置参数)

全局默认配置option项：

```javascript
{
    baseUrl: '', // 请求根域名
    header: {}, // 默认请求头
    contentType: 'json', // json
    method: 'POST', // 默认请求方法
    // #ifdef H5 || APP-PLUS || MP-ALIPAY || MP-WEIXIN
    timeout: 6000,
    // #endif
    dataType: 'json', // 如果设为 json，会尝试对返回的数据做一次 JSON.parse
    // #ifndef MP-ALIPAY
    responseType: 'text', // 响应的数据类型
    // #endif
    // #ifdef APP-PLUS
    sslVerify: true, // 验证 ssl 证书
    firstIpv4: false, // DNS解析时优先使用ipv4
    // #endif
    // #ifdef H5
    withCredentials: false, // 跨域请求时是否携带凭证
    // #endif
    showLoading: true, // 是否显示请求中的loading
    loadingText: '加载中...',
    loadingTime: 2000, // ms
    loadMask: false, // 是否给一个透明的遮罩层，防止点击穿透
    iconType: 'success', // 请求成功后提示icon类型 默认success
    timer: null, // 定时器
    debug: false, // 是否为调试，打印出信息
    // 增加状态码验证，默认http code 200 ～ 300，返回succes，反之则返回fail
    validateStatus: status => {
        // http code默认为200~300标识为成功
        return (status >= 200 && status < 300)
    }
  }
```

### [通过setConfig方法设置全局变量](http://mid.chinatowercom.cn:18080/appGuide/base/request.html#通过setconfig方法设置全局变量)

setConfig 支持callback模式及Object变量模式

```javascript
const request = new ctmobile.request({
	baseUrl: <url>,
	timeout: <timeOut>,
})

// 通过 callBack 模式
request.setConfig((config) => {
  config.debug = true
  return config
})

// 通过 Object 变量模式
request.setConfig({
  debug: true
})
```

### [Get 请求](http://mid.chinatowercom.cn:18080/appGuide/base/request.html#get-请求)

具体参数可参照：[uni.request](https://uniapp.dcloud.io/api/request/request.html#request)

```javascript
// 基础使用
this.$request.get(url, {
  data: {} // 参数
  <otherOptions>
}).then((res) => {
  console.log('res', res)
}).catch(err => {
  console.log('err', err)
})
<template>
	<view class="demo-page">
		<ct-demo-card title="Get请求" class="mb">
			<ct-ui-button @click="getList" fontSize="14">Get请求</ct-ui-button>
		</ct-demo-card>
	</view>
</template>

<script>
	export default {
		data() {
			return {}
		},
		onLoad() {},
		methods: {
			getList() {
				this.$request.get('/posts', {
                  data: {
                      category: 1,
                      status: 1,
                      page: 1, 
                      pageSize: 10      
                  },
                  debug: true,
                  loadingText: '努力加载中...',
                  handlerTask: (task) => {
                      // do task
                      task.abort()
                  },
                }).then((res) => {
                    console.log('res', res)
                })
			},
		}
	}
</script>
```

### [Post 请求](http://mid.chinatowercom.cn:18080/appGuide/base/request.html#post-请求)

具体参数可参照：[uni.request](https://uniapp.dcloud.io/api/request/request.html#request)

```javascript
// 基础使用
this.$request.post(url, <data={}>, {
  <otherOptions>
}).then((res) => {
  console.log('res', res)
}).catch(err => {
  console.log('err', err)
})
<template>
	<view class="demo-page">
		<ct-demo-card title="Post请求" class="mb">
			<ct-ui-button @click="createPost" fontSize="14">Post请求</ct-ui-button>
		</ct-demo-card>
	</view>
</template>

<script>
	export default {
		data() {
			return {}
		},
		onLoad() {},
		methods: {
			createPost() {
				this.$request.post('/posts', {
                    title: 'request 请求',
                },{
                    debug: true,
                    loadingText: '处理中...'
                }).then((res) => {
                    console.log('res', res)
                })
			},
		}
	}
</script>
```

### [Request 请求](http://mid.chinatowercom.cn:18080/appGuide/base/request.html#request-请求)

Request请求提供集成`Get`、`Post`请求，默认 **method** 为`post`请求

```javascript
// 基础使用
this.$request.request({
  url: '请求地址',
  method: 'post',
  data: {},
  <options>
}).then((res) => {
  console.log('res', res)
}).catch(err => {
  console.log('err', err)
})
<template>
	<view class="demo-page">
		<ct-demo-card title="Request请求" class="mb">
			<ct-ui-button @click="request" fontSize="14">Request请求</ct-ui-button>
		</ct-demo-card>
	</view>
</template>

<script>
	export default {
		data() {
			return {}
		},
		onLoad() {},
		methods: {
			request() {
				this.$request.post({
                  url: '/posts',
                  method: 'post',
                  data: {
                      title: 'foo',
                      body: 'bar',
                      userId: 1,
                  },
                  debug: true,
                  handlerTask: (task) => {
                      // do task
                      task.abort()
                  },
                }).then((res) => {
                    console.log('res', res)
                })
			},
		}
	}
</script>
```

### [UPLOAD 文件上传请求](http://mid.chinatowercom.cn:18080/appGuide/base/request.html#upload-文件上传请求)

具体参数可参照：[uni.uploadFile](https://uniapp.dcloud.io/api/request/network-file.html#uploadfile)

```javascript
// 基础使用
this.$request.upload(url, options = {}).then((res) => {
  console.log('res', res)
}).catch(err => {
  console.log('err', err)
})
<template>
	<view class="demo-page">
		<ct-demo-card title="UPLOAD请求" class="mb">
			<ct-ui-button @click="upload" fontSize="14">UPLOAD请求</ct-ui-button>
		</ct-demo-card>
	</view>
</template>

<script>
	export default {
		data() {
			return {}
		},
		onLoad() {},
		methods: {
			upload() {
				this.$request.upload('/posts', {
                    filePath: '', // 要上传文件资源的路径
                    formData: {}, // HTTP 请求中其他额外的 form data
                    debug: true,
                }).then((res) => {
                    console.log('res', res)
                })
			},
		}
	}
</script>
```

### [DOWNLOAD 下载文件请求](http://mid.chinatowercom.cn:18080/appGuide/base/request.html#download-下载文件请求)

具体参数可参照：[uni.downloadFile](https://uniapp.dcloud.io/api/request/network-file.html#downloadfile)

```javascript
// 基础使用
this.$request.download(url, options = {}).then((res) => {
  console.log('res', res)
}).catch(err => {
  console.log('err', err)
})
<template>
	<view class="demo-page">
		<ct-demo-card title="DOWNLOAD请求" class="mb">
			<ct-ui-button @click="download" fontSize="14">DOWNLOAD请求</ct-ui-button>
		</ct-demo-card>
	</view>
</template>

<script>
	export default {
		data() {
			return {}
		},
		onLoad() {},
		methods: {
			download() {
				this.$request.download('/posts',{
                    debug: true,
                    handlerTask: (task) => {
                        // do task
                        task.abort()
                    },
                }).then((res) => {
                  console.log('res', res)
                })
			},
		}
	}
</script>
```

### [Interceptor 拦截器（请求/响应拦截器）](http://mid.chinatowercom.cn:18080/appGuide/base/request.html#interceptor-拦截器-请求-响应拦截器)

Interceptor 拦截器（请求/响应拦截器），方式和常用Axios拦截器一样使用，统一请求及响应处理，统一的错误处理等。

```javascript
request.interceptors.request.use(request => {
    uni.showToast({
        title: '我是来自请求拦截器',
        icon: 'none'
    })

    // do something before request is sent
    request.header['token'] = 'Bearer xxxxxxxx'

    return request
  },
  error => {
    // do something with request error
    console.log(error)
    return Promise.reject(error)
  }
)

request.interceptors.response.use(response => {
    uni.showToast({
        title: '我是来自响应拦截器',
        icon: 'none'
    })
    console.log('response', response)
    const res = response.data

    // do something for response

    return res
  },
  error => {
      // do something with response error
      console.log(error)
      return Promise.reject(error)
  }
)
```